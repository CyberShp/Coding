# 灰盒测试核心价值说明

## 黑盒 vs 灰盒：为什么需要「多函数交汇临界点」

在黑盒测试中，例如 **iSCSI login** 场景：

- 可能会叠加 **端口闪断** 或 **网卡下电**（代码里各有对应的处理分支/函数）。
- **预期内的失败**：建联失败、返回超时或错误码 —— 这是可接受的。
- **预期外的不可接受结果**：控制器下电、进程崩溃、不可恢复状态 —— 这些往往需要大量随机或组合测试才能「撞」出来。

黑盒的问题在于：不知道代码里哪些函数、哪些故障处理分支会在**同一时刻交汇**，只能靠 N 次测试提高命中率。

灰盒测试的核心诉求是：**精准找到 2 个、3 个或多个函数（或故障处理分支）相关联的临界点**，设计**一次**灰盒测试用例就能把该问题暴露出来。

## 示例：iSCSI login 交汇场景

| 维度 | 说明 |
|------|------|
| **关联函数** | `login()`、`handle_port_flap()`、`handle_card_power_off()`（或对应分支） |
| **预期失败（可接受）** | 建联失败、连接超时、返回错误码 |
| **不可接受结果** | 控制器下电、进程崩溃、不可恢复错误 |
| **灰盒用例目标** | 在 login 过程中注入端口闪断或网卡下电，观察是否仅出现「建联失败」而不会出现「控制器下电/进程崩溃」 |

一次设计好的灰盒用例（明确触发 login + 端口闪断/网卡下电 的交汇），即可验证临界行为，而不依赖黑盒的 N 次随机撞。

## GrayScope 如何支撑

1. **调用图 + 错误路径 + 数据流**：分析器产出函数间调用关系、错误路径上的调用链、跨函数参数传播，为「谁和谁交汇」提供依据。
2. **关联函数与临界点**：发现中可携带 `related_functions`、`expected_failure`、`unacceptable_outcomes`，测试用例中突出展示「关联函数」「预期失败」「不可接受结果」。
3. **AI 综合**：跨模块综合分析时，要求 AI 输出 `critical_combinations`（多函数交汇临界点），包含上述三项，用于生成或补全灰盒场景。
4. **可读性**：测试用例模板与导出（含 Markdown）均包含「关联函数」「预期失败」「不可接受结果」，便于新手理解与执行。

### 在界面中查看「多函数交汇临界点」

- 打开 **任务详情** → 切到 **「AI 增强」** 标签 → 在 **「跨模块综合分析」** 卡片最上方可见 **「多函数交汇临界点」** 区块（该区块始终显示，无数据时会有说明）。
- 仅当本次分析**启用了跨模块 AI 综合**且分析成功完成后，AI 才会产出 `critical_combinations`；有内容时每条展示：**关联函数/分支**、**预期失败（可接受）**、**不可接受结果**、场景简述。

### 「交汇」指什么？是同一个变量吗？

**不单指同一个变量。** 交汇 = 多个函数/多个分支在**同一场景、同一时间窗口**下**同时参与**形成的临界点，包括：

| 类型 | 说明 |
|------|------|
| **执行路径/调用链** | 例如 A 调用 B，B 在错误路径上又触发 C，A/B/C 在同一次请求里交汇。 |
| **故障注入时机** | 例如 iSCSI login 执行中，端口闪断处理、网卡下电处理被触发，多条故障处理分支在同一场景下交汇。 |
| **同一变量（竞态）** | 多线程写同一共享变量，属于「并发」分析里的交汇，只是交汇的一种。 |

灰盒要找的是：**在这些交汇点上，预期内可接受「建联失败」等，但若出现「控制器下电、进程崩溃」则为不可接受**；一次针对该交汇点的用例即可验证，无需 N 次黑盒盲测。

## 小结

- **黑盒**：不知道内部分支与函数关系，靠大量测试撞出边界与异常。
- **灰盒**：利用代码结构（调用图、错误路径、数据流）找到**多函数/多分支交汇的临界点**，用**少量精准用例**暴露预期外不可接受结果。
- GrayScope 的「灵魂」即：把**函数间关系**和**交汇临界点**变成一等公民，让测试用例直接体现「测的是哪几个函数在什么场景下交汇、什么是可接受失败、什么是不可接受结果」。
